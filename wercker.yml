box: wercker-labs/docker
build:
  steps:
    - script:
        name: docker version
        code: sudo docker version
    - script:
        name: docker build
        code: sudo docker build -t bryantebeeklifely/partup app
  after-steps:
    - kobim/slack-post:
        url: $SLACK_URL
        channel: notifications
deploy:
  steps:
    - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        tag: $WERCKER_GIT_BRANCH
        repository: bryantebeeklifely/partup
        registry: https://registry.hub.docker.com
    - script:
        name: install ansible
        code: |
            apt-get update
            apt-get install --no-install-recommends -y software-properties-common
            apt-add-repository ppa:ansible/ansible
            apt-get update
            apt-get install -y ansible
    - script:
        name: write lifely server
        code: |-
            echo -ne $SERVER_KEY > ~/.ssh/lifely-server
            echo -ne $SERVER_KEY_PUB > ~/.ssh/lifely-server.pub
            chmod 400 ~/.ssh/lifely-server
            chmod 400 ~/.ssh/lifely-server.pub
    - script:
        name: deploy to given environment
        code: ./devops provision ${WERCKER_DEPLOYTARGET_NAME} --tags=app
        cwd: devops-new
  after-steps:
    - kobim/slack-post:
        url: $SLACK_URL
        channel: notifications
