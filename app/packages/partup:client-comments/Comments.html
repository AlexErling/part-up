<template name="Comments">
    <!-- Comments -->
    <footer class="pu-commentfield">
        {{# if showComments }}
            <!-- View all n comments -->
            {{#if showExpandButton }}
                <!-- data-expand-comments -->
                <p class="pu-sub-view-all-comments-button">
                    <!-- Determine the correct pathFor -->
                    <a href="
                        {{ #if partupContainsOne update.type 'partups_newuser' }}
                            {{pathFor route='profile' _id=user_id }}
                        {{else}}
                            {{pathFor route='partup-update' slug=partup.slug update_id=update._id }}
                        {{/if}}
                    ">
                        {{_ 'widgetcommentfield-comment-viewall-button' update.comments_count }}
                    </a>
                </p>
            {{/if }}

            <!-- Comments list -->
            <ul class="pu-list pu-list-comments">
                {{#each shownComments }}
                    <li>
                        <p class="{{# if isSystemMessage }}pu-sub-systemmessage{{/ if}}">
                            {{# if isMotivation }}
                                <span rel="author" data-usercard="{{creator._id}}">{{ creator.name }}</span>'s
                                {{_ 'widgetcommentfield-comment-motivation-prefix' }}{{{ partupAutolink content }}}
                            {{else}}
                                <span rel="author" data-usercard="{{creator._id}}">{{ creator.name }}</span>
                                {{# if isSystemMessage }}
                                    {{{ systemMessage content }}}
                                {{ else }}
                                    {{{ partupAutolink content }}}
                                {{/ if }}
                            {{/ if}}
                            <time title="{{ partupDateFull created_at }}" datetime="{{ created_at.toISOString }}">{{ partupDateComment created_at }}</time>
                        </p>
                    </li>
                {{/each }}
            </ul>
        {{/ if }}

        <!-- Add comment field -->
        {{#autoForm schema=formSchema id=generateFormId class='pu-state-expanded' }}
            <ul class="pu-list {{# unless showCommentFormAndMayComment }}pu-state-hidden{{/ unless }} {{# unless isMotivation }}pu-list-fieldwithbutton pu-list-fieldwithbutton-init-inactive {{#if buttonActive }}pu-list-fieldwithbutton-state-active{{/if }}{{/ unless }}">
                <li class="{{#if messageTooLong}}pu-state-error{{/if}}">
                    {{# if isMotivation }}
                        {{> afFieldInput type='textarea' name='content' class='pu-textarea' data='commentfield' placeholder=placeholders.comment }}
                    {{ else }}
                        {{> afFieldInput type='textarea' name='content' class='pu-textarea pu-textarea-grow' data='commentfield' placeholder=placeholders.comment rows=messageRows }}
                    {{/ if }}
                    {{#if messageTooLong}}
                        <span class="pu-sub-error">{{_ 'widgetcommentfield-comment-maxreached'}}</span>
                    {{/if}}
                </li>
                <li>
                    <button type="submit" class="pu-button pu-button-inputheight {{# if submitting }}pu-state-disabled pu-state-loading{{/ if }}">
                        <span>{{_ 'widgetcommentfield-comment-postbutton' }}</span>
                        {{> Spinner color='inverted' type='small' }}
                    </button>
                </li>
            </ul>
        {{/autoForm}}
    </footer>
</template>
