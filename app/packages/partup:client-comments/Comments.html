<template name="Comments">
    <!-- Comments -->
    <footer class="pu-commentfield">
        {{# if showComments }}
            <!-- View all n comments -->
            {{#if showExpandButton }}
                <!-- data-expand-comments -->
                <p class="pu-sub-view-all-comments-button">
                    <!-- Determine the correct pathFor -->
                    <a href="
                        {{ #if partupContainsOne update.type 'partups_newuser' }}
                            {{pathFor route='profile' _id=user_id }}
                        {{else}}
                            {{pathFor route='partup-update' slug=partup.slug update_id=update._id }}
                        {{/if}}
                    ">
                        {{_ 'widgetcommentfield-comment-viewall-button' update.comments_count }}
                    </a>

                    {{#unless commentButtonClicked}}
                        {{#if update.comments_count}}
                            <span class="pu-sub-seperator"></span>
                        {{/if}}
                        <a href="#" data-expand-comments>
                            Reageer
                        </a>
                    {{/unless}}
                </p>
            {{else}}
                {{#unless commentButtonClicked}}
                    {{#if update.comments_count}}
                        <p class="pu-sub-view-all-comments-button">
                            {{_ 'widgetcommentfield-comment-totalcomments' update.comments_count }} - {{newComments upper_data=update.upper_data}} new
                            <span class="pu-sub-seperator"></span>
                            <a href="#" data-expand-comments>
                                Reageer
                            </a>
                        </p>
                    {{/if}}
                {{/unless}}
            {{/if }}

            <!-- Comments list -->
            <ul class="pu-list pu-list-comments">
                {{#each shownComments }}
                    <li class="pu-comment">
                        <figure data-usercard="{{creator._id}}" class="pu-avatar pu-avatar-small pu-avatar-square" style="{{#with creator.image }}background-image:url('{{ partupImageUrl id=. store='360x360'}}');{{/with }}"></figure>
                        <div>
                            <p class="{{# if isSystemMessage }}pu-sub-systemmessage{{/ if}}">
                                {{# if isMotivation }}
                                    <span rel="author" data-usercard="{{creator._id}}">{{ creator.name }}</span>'s
                                    {{_ 'widgetcommentfield-comment-motivation-prefix' }}{{{ partupAutolink content }}}
                                {{else}}
                                    <span rel="author" data-usercard="{{creator._id}}">{{ creator.name }}</span>
                                    {{# if isSystemMessage }}
                                        {{{ systemMessage content }}}
                                    {{ else }}
                                        {{{ partupAutolink content }}}
                                    {{/ if }}
                                {{/ if}}
                            </p>
                            <time title="{{ partupDateFull created_at }}" datetime="{{ created_at.toISOString }}">{{ partupDateComment created_at }}</time>
                        </div>
                    </li>
                {{/each }}
            </ul>
        {{/ if }}

        <!-- Add comment field -->
        {{#autoForm schema=formSchema id=generateFormId class='pu-state-expanded' }}
            <ul class="pu-list {{# unless showCommentFormAndMayComment }}pu-state-hidden{{/ unless }} {{# unless isMotivation }}pu-list-fieldwithbutton pu-list-fieldwithbutton-init-inactive {{#if buttonActive }}pu-list-fieldwithbutton-state-active{{/if }}{{/ unless }}">
                <li class="{{#if messageTooLong}}pu-state-error{{/if}}">
                    {{# if isMotivation }}
                        {{> afFieldInput type='textarea' name='content' class='pu-textarea' data='commentfield' placeholder=placeholders.comment }}
                    {{ else }}
                        {{> afFieldInput type='textarea' name='content' class='pu-textarea pu-textarea-grow' data='commentfield' placeholder=placeholders.comment rows=messageRows }}
                    {{/ if }}
                    {{#if messageTooLong}}
                        <span class="pu-sub-error">{{_ 'widgetcommentfield-comment-maxreached'}}</span>
                    {{/if}}
                </li>
                <li>
                    <button type="submit" class="pu-button pu-button-inputheight {{# if submitting }}pu-state-disabled pu-state-loading{{/ if }}">
                        <span>{{_ 'widgetcommentfield-comment-postbutton' }}</span>
                        {{> Spinner color='inverted' type='small' }}
                    </button>
                </li>
            </ul>
        {{/autoForm}}
    </footer>
</template>
