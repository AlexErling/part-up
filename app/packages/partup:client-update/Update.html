<template name="Update">

    <section class="pu-update">
        <aside>

            <!-- User -->
            {{# if metadata.is_system }}
                <figure class="pu-avatar pu-avatar-update pu-avatar-system">
                    <span class="pu-sub-image"></span>
                </figure>
            {{ else }}
                <figure class="pu-avatar pu-avatar-update">
                    <a href="#" rel="author" data-usercard="{{ metadata.updateUpper._id }}" class="pu-sub-image" style="{{#with metadata.updateUpper.profile.image }}background-image: url('{{ partupImageUrl id=. store='80x80' }}');{{/with}}"></a>
                </figure>
            {{/ if }}

            <!-- Time -->
            <p class="pu-sub-time">
                <time datetime="{{ metadata.updated_at.toISOString }}" title="{{ partupDateFull metadata.updated_at }}">{{ partupDatePartupActivity metadata.updated_at }}</time>
            </p>

        </aside>
        <section>

            <!-- Title & first comment button -->
            <header>
                <h3>
                    {{#if LINK }}
                        <a href="{{ metadata.path }}">{{ title }}</a>
                    {{else}}
                        {{ title }}
                    {{/if }}
                </h3>
                <!-- Top comment button -->
                {{#if metadata.is_contribution }}

                    <!-- When the update is a contribution-update, link to the activity -->
                    <a class="pu-button pu-button-text" href="{{ metadata.path }}">{{_ 'update-comment-button' }}</a>

                {{else}}

                    <!-- Only show the comment button when the update is commentable -->
                    {{# if commentable }}
                        {{# unless showCommentForm }}
                            <a class="pu-button pu-button-text" data-expand-comment-field>{{_ 'update-comment-button' }}</a>
                        {{/unless }}
                    {{/ if }}

                {{/if}}
            </header>

            <!-- - - - - - - - - - - TYPES START - - - - - - - - - - -->

            <!-- partups_message_added -->
            {{#if partupEqualsExactly update.type 'partups_message_added' }}
                {{# if metadata.is_system }}
                    {{# with update.type_data }}
                        <section>
                            <article class="pu-block pu-block-message">
                                <p class="pu-paragraph">{{{ safeHTML systemMessageContent }}}</p>
                            </article>
                        </section>
                    {{/ with}}
                {{ else }}
                    {{# with update.type_data }}
                        <section>
                            <article class="pu-block pu-block-message">
                                <p class="pu-paragraph">{{{ safeHTML messageContent }}}</p>
                                {{# if images }}
                                    <figure>
                                        {{# each images }}
                                            <img class="pu-image" src="{{ partupImageUrl id=. }}" alt="">
                                        {{/ each }}
                                    </figure>
                                {{/ if}}
                            </article>
                        </section>
                    {{/ with}}
                {{/ if }}
            {{/if }}

            <!-- partups_tags_added -->
            {{#if partupEqualsExactly update.type 'partups_tags_added' }}
                {{#with update.type_data }}
                    <section>
                        <span class="pu-tag">{{ new_tag }}</span>
                    </section>
                {{/with}}
            {{/if }}

            <!-- partups_tags_removed -->
            {{#if partupEqualsExactly update.type 'partups_tags_removed' }}
                {{#with update.type_data }}
                    <section>
                        <span class="pu-tag">{{ old_tag }}</span>
                    </section>
                {{/with}}
            {{/if }}

            <!-- partups_tags_changed -->
            {{#if partupEqualsExactly update.type 'partups_tags_changed' }}
                {{#with update.type_data }}
                    <section>
                        <ul class="pu-list pu-list-horizontal pu-list-tags pu-list-arrows">
                            <li><span class="pu-tag">{{ old_tag }}</span></li>
                            <li><span class="pu-tag">{{ new_tag }}</span></li>
                        </ul>
                    </section>
                {{/with}}
            {{/if }}

            <!-- partups_end_date_changed -->
            {{#if partupEqualsExactly update.type 'partups_end_date_changed' }}
                {{#with update.type_data }}
                    <section>
                        <ul class="pu-list pu-list-horizontal pu-list-tags pu-list-arrows">
                            <li><span class="pu-tag pu-tag-angular">{{ partupDateNormal old_end_date }}</span></li>
                            <li><span class="pu-tag pu-tag-angular">{{ partupDateNormal new_end_date }}</span></li>
                        </ul>
                    </section>
                {{/with}}
            {{/if }}

            <!-- partups_name_changed -->
            {{#if partupEqualsExactly update.type 'partups_name_changed' }}
                {{#with update.type_data }}
                    <section>
                        <p class="pu-title pu-title-updateitem">{{ new_name }}</p>
                    </section>
                {{/with}}
            {{/if }}

            <!-- partups_description_changed -->
            {{#if partupEqualsExactly update.type 'partups_description_changed' }}
                {{#with update.type_data }}
                    <section>
                        <p class="pu-paragraph pu-paragraph-large">{{ new_description }}</p>
                    </section>
                {{/with}}
            {{/if }}

            <!-- partups_image_changed -->
            {{#if partupEqualsExactly update.type 'partups_image_changed' }}
                {{#with update.type_data }}
                    <section>
                        <img class="pu-image" src="{{ partupImageUrl id=new_image store='1200x520' }}">
                    </section>
                {{/with}}
            {{/if }}

            <!-- partups_budget_changed -->
            {{#if partupEqualsExactly update.type 'partups_budget_changed' }}
                {{#with update.type_data }}
                    <section>
                        <ul class="pu-list pu-list-horizontal pu-list-tags pu-list-arrows">
                            <li><span class="pu-tag pu-tag-angular">{{ oldBudget }}</span></li>
                            <li><span class="pu-tag pu-tag-angular">{{ newBudget }}</span></li>
                        </ul>
                    </section>
                {{/with}}
            {{/if }}

            <!-- partups_location_changed -->
            {{#if partupEqualsExactly update.type 'partups_location_changed' }}
                {{#with update.type_data }}
                    <section>
                        <ul class="pu-list pu-list-horizontal pu-list-tags pu-list-arrows">
                            <li><span class="pu-tag pu-tag-angular">{{ old_location.city }}</span></li>
                            <li><span class="pu-tag pu-tag-angular">{{ new_location.city }}</span></li>
                        </ul>
                    </section>
                {{/with}}
            {{/if }}

            <!-- partups_invited -->
            {{#if partupEqualsExactly update.type 'partups_invited' }}
                {{#with update.type_data }}
                    <!-- no template, only title -->
                {{/with}}
            {{/if }}

            <!-- activity related updates -->
            {{# if update.isActivityUpdate }}
                {{#with update.type_data }}
                    <section>
                        {{> Activity activity=activityData EXPANDABLE=isDetail EXPANDED=isDetail UPDATE_LINK=isNotDetail READONLY=isNotDetail isUpper=isUpper }}
                    </section>
                {{/with}}
            {{/if }}

            <!-- contribution related updates -->
            {{#if update.isContributionUpdate }}
                {{#with update.type_data }}
                    <section>
                        {{> Activity activity=activityData contribution_id=contribution_id COMPACT=true EXPANDED=true READONLY=true }}
                    </section>
                {{/with}}
            {{/if }}

            <!-- - - - - - - - - - - TYPES END - - - - - - - - - - -->

            <!-- Comments -->
            {{# if update }}
                {{#if commentable }}
                    {{> Comments update=update showCommentForm=showCommentForm SHOW_COMMENTS=SHOW_COMMENTS LIMIT=COMMENT_LIMIT }}
                {{/if }}
            {{/ if }}
        </section>
    </section>

</template>
